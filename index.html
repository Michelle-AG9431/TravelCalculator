<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…è²»åˆ†å¸³ - æ–‡é’æ°´å½©ç‰ˆ (é€²éšåˆ†å¸³)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Noto Serif TC', serif;
            background: #fdfbf7;
            background-image: 
                radial-gradient(at 10% 10%, rgba(255, 220, 220, 0.4) 0px, transparent 50%),
                radial-gradient(at 90% 0%, rgba(200, 230, 255, 0.4) 0px, transparent 50%),
                radial-gradient(at 50% 90%, rgba(220, 255, 220, 0.4) 0px, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #4a4a4a;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        .watercolor-btn {
            background-image: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            transition: all 0.3s ease;
        }
        .watercolor-btn:active {
            transform: scale(0.95);
        }
        .category-tag {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            background: rgba(0,0,0,0.05);
        }
        /* Custom Tab Style */
        .tab-active {
            background-color: #bfdbfe; /* blue-200 */
            color: #1e3a8a; /* blue-900 */
            font-weight: bold;
        }
        .tab-inactive {
            background-color: #f3f4f6; /* gray-100 */
            color: #6b7280; /* gray-500 */
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
    </style>
</head>
<body class="pb-24">

<div id="app" class="max-w-md mx-auto p-4 relative min-h-screen">

    <div v-if="!currentUser" class="flex flex-col items-center justify-center h-[80vh] space-y-6">
        <h1 class="text-3xl font-bold text-gray-700 tracking-widest">æ—…è²» Â· éš¨ç­†</h1>
        <p class="text-sm text-gray-500">ç´€éŒ„æ—…è¡Œä¸­çš„æ¯ä¸€ç­†ç¾å¥½</p>
        
        <div class="glass-card p-8 w-full">
            <label class="block mb-2 text-sm text-gray-600">ä½ çš„åå­—</label>
            <input v-model="loginName" type="text" class="w-full p-3 rounded-lg bg-white/50 border border-gray-200 focus:outline-none focus:border-blue-300 mb-4" placeholder="è¼¸å…¥æš±ç¨±...">
            
            <label class="block mb-2 text-sm text-gray-600">é¸æ“‡é ­åƒ</label>
            <div class="grid grid-cols-5 gap-2 mb-6">
                <button v-for="avi in avatars" :key="avi" @click="selectedAvatar = avi"
                    :class="{'ring-2 ring-blue-300 bg-blue-50': selectedAvatar === avi}"
                    class="text-2xl p-2 rounded-full hover:bg-gray-100 transition">
                    {{ avi }}
                </button>
            </div>

            <button @click="login" :disabled="!loginName" class="w-full watercolor-btn text-gray-700 font-bold py-3 rounded-xl shadow-md disabled:opacity-50">
                é–‹å§‹æ—…ç¨‹
            </button>
        </div>
    </div>

    <div v-else>
        <header class="flex justify-between items-center mb-6 pt-2">
            <div class="flex items-center gap-3">
                <div class="text-3xl bg-white rounded-full p-1 shadow-sm">{{ currentUser.avatar }}</div>
                <div>
                    <div class="font-bold text-lg">{{ currentUser.name }}</div>
                    <div v-if="currentTrip" class="text-xs text-gray-500 cursor-pointer" @click="currentTrip = null">
                        <i class="fas fa-chevron-left"></i> å›åˆ°è¡Œç¨‹åˆ—è¡¨
                    </div>
                </div>
            </div>
            <button @click="showSettlement = true" v-if="currentTrip" class="text-sm bg-white/80 px-3 py-1.5 rounded-full shadow-sm text-gray-600">
                <i class="fas fa-calculator"></i> çµç®—
            </button>
        </header>

        <div v-if="!currentTrip" class="space-y-4">
            <h2 class="text-xl font-bold text-gray-700 mb-4">æˆ‘çš„æ—…ç¨‹</h2>
            
            <div @click="showNewTripModal = true" class="glass-card p-6 flex flex-col items-center justify-center border-dashed border-2 border-gray-300 cursor-pointer hover:bg-white/90 transition text-gray-400">
                <i class="fas fa-plus text-2xl mb-2"></i>
                <span>é–‹å•Ÿä¸€æ®µæ–°æ—…ç¨‹</span>
            </div>

            <div v-for="trip in trips" :key="trip.id" @click="selectTrip(trip)" class="glass-card p-5 cursor-pointer hover:scale-[1.02] transition relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-6xl opacity-10 rotate-12">âœˆï¸</div>
                <h3 class="text-lg font-bold text-gray-800">{{ trip.name }}</h3>
                <p class="text-xs text-gray-500 mt-1">{{ formatDate(trip.startDate) }} - {{ formatDate(trip.endDate) }}</p>
                <div class="mt-3 flex -space-x-2">
                    <div v-for="u in trip.users" :key="u.name" class="w-6 h-6 rounded-full bg-gray-200 border-2 border-white flex items-center justify-center text-xs">
                        {{ u.avatar }}
                    </div>
                </div>
            </div>
        </div>

        <div v-else>
            <div class="glass-card p-4 mb-4 bg-gradient-to-r from-blue-50 to-purple-50">
                <p class="text-xs text-gray-500">ç›®å‰ç¸½æ”¯å‡º (TWD)</p>
                <p class="text-3xl font-bold text-gray-800 font-sans tracking-tight">NT$ {{ formatMoney(totalTripExpense) }}</p>
                <div class="flex gap-2 mt-2 overflow-x-auto pb-1">
                     <span v-for="(amt, cat) in categoryTotals" :key="cat" class="category-tag whitespace-nowrap">
                        {{ cat }}: ${{ formatMoney(amt) }}
                     </span>
                </div>
            </div>

            <div class="space-y-3 pb-20">
                <div v-for="exp in tripExpenses" :key="exp.id" @click="openEditExpense(exp)" class="glass-card p-4 flex justify-between items-center group cursor-pointer hover:bg-white/90 transition">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-xl shadow-inner">
                            {{ getCategoryIcon(exp.category) }}
                        </div>
                        <div>
                            <p class="font-bold text-gray-700 leading-tight">{{ exp.note || exp.category }}</p>
                            <p class="text-xs text-gray-400 mt-0.5">
                                {{ exp.payer.name }} ä»˜æ¬¾ 
                                <span v-if="exp.splitMethod === 'custom'" class="text-blue-400 ml-1">(è‡ªè¨‚)</span>
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-gray-800">NT$ {{ formatMoney(exp.amountTWD) }}</p>
                        <p class="text-xs text-gray-400" v-if="exp.currency !== 'TWD'">
                            {{ exp.currency }} {{ exp.originalAmount }}
                        </p>
                    </div>
                </div>
                <div v-if="tripExpenses.length === 0" class="text-center text-gray-400 mt-10">
                    <i class="fas fa-pen-fancy text-4xl mb-3 opacity-30"></i>
                    <p>å°šæœªæœ‰ä»»ä½•èŠ±è²»ç´€éŒ„</p>
                </div>
            </div>

            <div class="fixed bottom-6 left-0 right-0 flex justify-center z-50">
                <button @click="openAddExpense" class="watercolor-btn text-gray-800 rounded-full px-8 py-4 shadow-lg flex items-center gap-2 transform hover:-translate-y-1 transition font-bold text-lg">
                    <i class="fas fa-plus"></i> æ–°å¢è²»ç”¨
                </button>
            </div>
        </div>
    </div>

    <div v-if="showNewTripModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-card p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">å»ºç«‹æ–°æ—…ç¨‹</h3>
            <input v-model="newTrip.name" class="w-full p-2 mb-3 bg-white/50 border rounded" placeholder="æ—…ç¨‹åç¨± (å¦‚: å¤§é˜ªè¡Œ)">
            <div class="flex gap-2 mb-4">
                <input v-model="newTrip.startDate" type="date" class="w-1/2 p-2 bg-white/50 border rounded">
                <input v-model="newTrip.endDate" type="date" class="w-1/2 p-2 bg-white/50 border rounded">
            </div>
            <div class="flex justify-end gap-2">
                <button @click="showNewTripModal = false" class="px-4 py-2 text-gray-500">å–æ¶ˆ</button>
                <button @click="createTrip" class="px-6 py-2 bg-blue-200 rounded-lg font-bold">å»ºç«‹</button>
            </div>
        </div>
    </div>

    <div v-if="showExpenseModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center">
        <div class="glass-card w-full max-w-md rounded-b-none sm:rounded-2xl p-6 h-[90vh] sm:h-auto overflow-y-auto animate-slide-up">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">{{ isEditing ? 'ç·¨è¼¯è²»ç”¨' : 'è¨˜ä¸€ç­†' }}</h3>
                <button @click="showExpenseModal = false" class="text-gray-400"><i class="fas fa-times text-xl"></i></button>
            </div>

            <div class="flex gap-2 mb-4">
                <div class="w-1/3">
                    <label class="text-xs text-gray-500 block mb-1">å¹£åˆ¥</label>
                    <select v-model="newExp.currency" @change="updateRate" class="w-full p-3 bg-white border border-gray-200 rounded-lg appearance-none">
                        <option v-for="c in currencies" :value="c">{{ c }}</option>
                    </select>
                </div>
                <div class="w-2/3">
                    <label class="text-xs text-gray-500 block mb-1">é‡‘é¡</label>
                    <input v-model.number="newExp.amount" type="number" class="w-full p-3 bg-white border border-gray-200 rounded-lg text-lg font-bold text-right" placeholder="0">
                </div>
            </div>

            <div class="mb-4 bg-gray-50 p-3 rounded-lg flex justify-between items-center">
                <span class="text-xs text-gray-500">åŒ¯ç‡ (1 {{newExp.currency}} = ? TWD)</span>
                <input v-model.number="newExp.rate" type="number" step="0.01" class="w-20 bg-transparent text-right border-b border-gray-300 focus:outline-none text-sm">
            </div>
            <p class="text-right text-sm font-bold text-gray-700 mb-4">
                â‰ˆ NT$ {{ formatMoney(Math.round(newExp.amount * newExp.rate)) }}
            </p>

            <div class="grid grid-cols-5 gap-2 mb-4">
                <div v-for="cat in categories" :key="cat.name" 
                     @click="newExp.category = cat.name"
                     :class="{'bg-blue-100 border-blue-300': newExp.category === cat.name}"
                     class="flex flex-col items-center p-2 rounded-lg border border-transparent cursor-pointer transition">
                    <div class="text-xl mb-1">{{ cat.icon }}</div>
                    <span class="text-[10px]">{{ cat.name }}</span>
                </div>
            </div>

            <input v-model="newExp.note" class="w-full p-3 bg-white border border-gray-200 rounded-lg mb-4" placeholder="å‚™è¨» (å¦‚: æ™šé¤ã€è»Šç¥¨...)">

            <div class="mb-4">
                <label class="text-xs text-gray-500 block mb-2">èª°å…ˆä»˜çš„ï¼Ÿ</label>
                <div class="flex gap-2 overflow-x-auto pb-1">
                    <button v-for="u in currentTrip.users" :key="u.name"
                        @click="newExp.payer = u"
                        :class="{'ring-2 ring-blue-400 bg-blue-50': newExp.payer.name === u.name}"
                        class="flex items-center gap-2 px-3 py-2 rounded-full border bg-white min-w-max">
                        <span>{{ u.avatar }}</span>
                        <span class="text-sm">{{ u.name }}</span>
                    </button>
                </div>
            </div>

            <div class="mb-6">
                <label class="text-xs text-gray-500 block mb-2">åˆ†çµ¦èª°ï¼Ÿ</label>
                
                <div class="flex mb-3 rounded-lg overflow-hidden border border-gray-200">
                    <button @click="newExp.splitMethod = 'equal'" 
                            class="flex-1 py-2 text-sm transition"
                            :class="newExp.splitMethod === 'equal' ? 'tab-active' : 'tab-inactive'">
                        å¹³å‡åˆ†æ”¤
                    </button>
                    <button @click="newExp.splitMethod = 'custom'" 
                            class="flex-1 py-2 text-sm transition"
                            :class="newExp.splitMethod === 'custom' ? 'tab-active' : 'tab-inactive'">
                        è‡ªè¨‚é‡‘é¡
                    </button>
                </div>

                <div v-if="newExp.splitMethod === 'equal'">
                    <div class="flex gap-2 mb-2">
                        <button @click="toggleSplitAll(true)" class="text-xs px-2 py-1 bg-gray-200 rounded">å…¨é¸</button>
                        <button @click="toggleSplitAll(false)" class="text-xs px-2 py-1 bg-gray-200 rounded">å…¨ä¸é¸</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div v-for="u in currentTrip.users" :key="u.name + 'split'" 
                             @click="toggleSplitUser(u)"
                             :class="{'bg-green-50 border-green-300': newExp.splitTo.includes(u.name)}"
                             class="flex items-center gap-2 p-2 rounded border border-gray-200 cursor-pointer">
                            <div v-if="newExp.splitTo.includes(u.name)" class="text-green-500"><i class="fas fa-check-circle"></i></div>
                            <div v-else class="text-gray-300"><i class="far fa-circle"></i></div>
                            <span class="text-sm">{{ u.name }}</span>
                        </div>
                    </div>
                </div>

                <div v-else>
                    <div class="space-y-2 max-h-40 overflow-y-auto">
                        <div v-for="u in currentTrip.users" :key="u.name + 'custom'" class="flex items-center justify-between p-2 border-b border-gray-100">
                            <div class="flex items-center gap-2">
                                <span>{{ u.avatar }}</span>
                                <span class="text-sm">{{ u.name }}</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="text-xs text-gray-400">{{ newExp.currency }}</span>
                                <input type="number" 
                                       v-model.number="newExp.customAmounts[u.name]" 
                                       class="w-24 p-1 bg-gray-50 border rounded text-right text-sm" 
                                       placeholder="0">
                            </div>
                        </div>
                    </div>
                    <div class="mt-2 text-right text-sm font-bold">
                        <span :class="remainingAmount === 0 ? 'text-green-500' : 'text-red-500'">
                            {{ remainingAmount === 0 ? 'å·²åˆ†é…å®Œç•¢' : (remainingAmount > 0 ? `é‚„æœ‰ ${formatMoney(remainingAmount)} æœªåˆ†` : `è¶…åˆ†äº† ${formatMoney(Math.abs(remainingAmount))}`) }}
                        </span>
                    </div>
                </div>
            </div>

            <div v-if="!isEditing">
                <button @click="saveExpense" 
                    :disabled="newExp.splitMethod === 'custom' && remainingAmount !== 0"
                    class="w-full watercolor-btn py-3 rounded-xl font-bold text-gray-800 shadow-md disabled:opacity-50 disabled:grayscale">
                    å„²å­˜è²»ç”¨
                </button>
            </div>
            <div v-else class="flex gap-3">
                <button @click="deleteExpense" class="flex-1 bg-red-100 text-red-600 py-3 rounded-xl font-bold shadow-md">
                    <i class="fas fa-trash-alt"></i> åˆªé™¤
                </button>
                <button @click="updateExpense" 
                    :disabled="newExp.splitMethod === 'custom' && remainingAmount !== 0"
                    class="flex-[2] watercolor-btn py-3 rounded-xl font-bold text-gray-800 shadow-md disabled:opacity-50 disabled:grayscale">
                    ç¢ºèªä¿®æ”¹
                </button>
            </div>

        </div>
    </div>

    <div v-if="showSettlement" class="fixed inset-0 bg-white z-50 overflow-y-auto p-6 animate-fade-in">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold">çµç®—å ±è¡¨</h2>
                <button @click="showSettlement = false" class="p-2 bg-gray-100 rounded-full"><i class="fas fa-times"></i></button>
            </div>

            <div class="space-y-6">
                <div v-if="debts.length > 0">
                    <h3 class="font-bold text-gray-600 mb-3 border-l-4 border-blue-300 pl-2">å»ºè­°è½‰å¸³</h3>
                    <div v-for="(debt, idx) in debts" :key="idx" class="glass-card p-4 flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-red-500">{{ debt.from }}</span>
                            <i class="fas fa-arrow-right text-gray-300"></i>
                            <span class="font-bold text-green-600">{{ debt.to }}</span>
                        </div>
                        <div class="font-bold text-lg">NT$ {{ formatMoney(debt.amount) }}</div>
                    </div>
                </div>
                <div v-else class="text-center text-gray-400 py-4">ç›®å‰æ”¶æ”¯å¹³è¡¡ï¼Œç„¡éœ€è½‰å¸³ï¼</div>

                <hr class="border-gray-200">

                <div>
                    <h3 class="font-bold text-gray-600 mb-3 border-l-4 border-purple-300 pl-2">å€‹äººæ”¶æ”¯è©³æƒ…</h3>
                    <div v-for="stat in userStats" :key="stat.name" class="glass-card p-4 mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">{{ stat.avatar }}</span>
                                <span class="font-bold">{{ stat.name }}</span>
                            </div>
                            <span :class="stat.balance >= 0 ? 'text-green-600' : 'text-red-500'" class="font-bold">
                                {{ stat.balance >= 0 ? 'æ”¶' : 'ä»˜' }} NT$ {{ formatMoney(Math.abs(stat.balance)) }}
                            </span>
                        </div>
                        <div class="text-xs text-gray-500 flex justify-between">
                            <span>å…ˆå¢Šä»˜: {{ formatMoney(stat.paid) }}</span>
                            <span>æ‡‰åˆ†æ”¤: {{ formatMoney(stat.share) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const firebaseConfig = {
  apiKey: "AIzaSyBSMNzpBI4SiECFCEt_HUaYoaGb1_gaLSI",
  authDomain: "travelcalculator-10c81.firebaseapp.com",
  projectId: "travelcalculator-10c81",
  storageBucket: "travelcalculator-10c81.firebasestorage.app",
  messagingSenderId: "776646417150",
  appId: "1:776646417150:web:e8be691a3eb7ad8d1723af",
  measurementId: "G-N1G80VWVT7"
};

    let db;
    if (firebaseConfig.apiKey === "YOUR_API_KEY") {
        alert("è«‹è¨˜å¾—åœ¨ index.html ç¨‹å¼ç¢¼ä¸­å†æ¬¡å¡«å…¥æ‚¨çš„ Firebase Configï¼");
    } else {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
    }

    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const currentUser = ref(JSON.parse(localStorage.getItem('travel_user')) || null);
            const loginName = ref('');
            const selectedAvatar = ref('ğŸ¦Š');
            const avatars = ['ğŸ¦Š', 'ğŸ±', 'ğŸ¶', 'ğŸ°', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ·', 'ğŸ¸'];
            
            const trips = ref([]);
            const currentTrip = ref(null);
            const tripExpenses = ref([]);
            
            const showNewTripModal = ref(false);
            const showExpenseModal = ref(false);
            const showSettlement = ref(false);

            const isEditing = ref(false);
            const currentExpenseId = ref(null);

            const currencies = ['TWD', 'USD', 'EUR', 'JPY', 'KRW', 'THB', 'HKD'];
            const exchangeRates = ref({ TWD: 1 });

            const newTrip = ref({ name: '', startDate: '', endDate: '' });
            const categories = [
                {name: 'äº¤é€š', icon: 'ğŸš„'}, 
                {name: 'é£²é£Ÿ', icon: 'ğŸœ'}, 
                {name: 'ä½å®¿', icon: 'ğŸ¨'}, 
                {name: 'é–€ç¥¨', icon: 'ğŸŸï¸'}, 
                {name: 'è³¼ç‰©', icon: 'ğŸ›ï¸'},
                {name: 'å…¶ä»–', icon: 'âœ¨'}
            ];
            
            // newExp æ–°å¢ splitMethod å’Œ customAmounts
            const newExp = ref({
                amount: null,
                currency: 'TWD',
                rate: 1,
                category: 'é£²é£Ÿ',
                note: '',
                payer: null,
                splitMethod: 'equal', // 'equal' or 'custom'
                splitTo: [], 
                customAmounts: {} // { name: amount }
            });

            const login = () => {
                const user = { name: loginName.value, avatar: selectedAvatar.value };
                currentUser.value = user;
                localStorage.setItem('travel_user', JSON.stringify(user));
                loadTrips();
            };

            const fetchRates = async () => {
                try {
                    const res = await fetch('https://open.er-api.com/v6/latest/TWD');
                    const data = await res.json();
                    currencies.forEach(c => {
                        if (data.rates[c]) {
                            exchangeRates.value[c] = 1 / data.rates[c];
                        }
                    });
                } catch (e) { console.error(e); }
            };

            const loadTrips = () => {
                if(!db) return;
                db.collection('trips').orderBy('createdAt', 'desc').onSnapshot(snap => {
                    trips.value = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                });
            };

            const createTrip = async () => {
                if(!newTrip.value.name) return;
                const tripData = {
                    name: newTrip.value.name,
                    startDate: newTrip.value.startDate,
                    endDate: newTrip.value.endDate,
                    users: [currentUser.value],
                    createdAt: new Date().toISOString()
                };
                await db.collection('trips').add(tripData);
                showNewTripModal.value = false;
                newTrip.value = { name: '', startDate: '', endDate: '' };
            };

            const selectTrip = (trip) => {
                currentTrip.value = trip;
                const isMember = trip.users.find(u => u.name === currentUser.value.name);
                if (!isMember) {
                    const updatedUsers = [...trip.users, currentUser.value];
                    db.collection('trips').doc(trip.id).update({ users: updatedUsers });
                    currentTrip.value.users = updatedUsers;
                }
                loadExpenses(trip.id);
            };

            const loadExpenses = (tripId) => {
                db.collection('expenses')
                  .where('tripId', '==', tripId)
                  .onSnapshot(snap => {
                      let list = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      list.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                      tripExpenses.value = list;
                  });
            };

            // é–‹å•Ÿæ–°å¢æ¨¡å¼
            const openAddExpense = () => {
                isEditing.value = false;
                currentExpenseId.value = null;
                // åˆå§‹åŒ– customAmounts
                let initialCustom = {};
                currentTrip.value.users.forEach(u => initialCustom[u.name] = 0);

                newExp.value = {
                    amount: null,
                    currency: 'TWD',
                    rate: 1,
                    category: 'é£²é£Ÿ',
                    note: '',
                    payer: currentUser.value,
                    splitMethod: 'equal',
                    splitTo: currentTrip.value.users.map(u => u.name),
                    customAmounts: initialCustom
                };
                showExpenseModal.value = true;
            };

            // é–‹å•Ÿç·¨è¼¯æ¨¡å¼
            const openEditExpense = (exp) => {
                isEditing.value = true;
                currentExpenseId.value = exp.id;
                
                // ç¢ºä¿èˆŠè³‡æ–™ä¹Ÿæœ‰ customAmounts çµæ§‹
                let loadedCustom = exp.customAmounts || {};
                currentTrip.value.users.forEach(u => {
                    if(loadedCustom[u.name] === undefined) loadedCustom[u.name] = 0;
                });

                newExp.value = {
                    amount: exp.originalAmount,
                    currency: exp.currency,
                    rate: exp.rate,
                    category: exp.category,
                    note: exp.note,
                    payer: exp.payer,
                    splitMethod: exp.splitMethod || 'equal',
                    splitTo: [...(exp.splitTo || [])],
                    customAmounts: loadedCustom
                };
                showExpenseModal.value = true;
            };

            const updateRate = () => {
                const cur = newExp.value.currency;
                if(exchangeRates.value[cur]) {
                    newExp.value.rate = parseFloat(exchangeRates.value[cur].toFixed(2));
                }
            };

            // è¼”åŠ©ï¼šè¨ˆç®—å‰©é¤˜é‡‘é¡ (for Custom Split)
            const remainingAmount = computed(() => {
                if(!newExp.value.amount) return 0;
                let assigned = 0;
                for (let name in newExp.value.customAmounts) {
                    assigned += (newExp.value.customAmounts[name] || 0);
                }
                // è§£æ±ºæµ®é»æ•¸èª¤å·®
                return parseFloat((newExp.value.amount - assigned).toFixed(2));
            });

            const getExpenseDataObj = () => {
                 return {
                    amountTWD: Math.round(newExp.value.amount * newExp.value.rate),
                    originalAmount: newExp.value.amount,
                    currency: newExp.value.currency,
                    rate: newExp.value.rate,
                    category: newExp.value.category,
                    note: newExp.value.note,
                    payer: newExp.value.payer,
                    // æ–°å¢æ¬„ä½
                    splitMethod: newExp.value.splitMethod,
                    splitTo: newExp.value.splitTo,
                    customAmounts: newExp.value.customAmounts
                };
            };

            const saveExpense = async () => {
                if(!newExp.value.amount) return;
                const baseData = getExpenseDataObj();
                const expenseData = {
                    ...baseData,
                    tripId: currentTrip.value.id,
                    date: new Date().toLocaleDateString('zh-TW'),
                    timestamp: new Date().toISOString()
                };
                await db.collection('expenses').add(expenseData);
                showExpenseModal.value = false;
            };

            const updateExpense = async () => {
                if(!currentExpenseId.value) return;
                const expenseData = getExpenseDataObj();
                await db.collection('expenses').doc(currentExpenseId.value).update(expenseData);
                showExpenseModal.value = false;
            };

            const deleteExpense = async () => {
                if(!currentExpenseId.value) return;
                if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è²»ç”¨å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸå–”ï¼')) {
                    await db.collection('expenses').doc(currentExpenseId.value).delete();
                    showExpenseModal.value = false;
                }
            };

            const toggleSplitUser = (user) => {
                const idx = newExp.value.splitTo.indexOf(user.name);
                if(idx > -1) newExp.value.splitTo.splice(idx, 1);
                else newExp.value.splitTo.push(user.name);
            };

            const toggleSplitAll = (select) => {
                if(select) newExp.value.splitTo = currentTrip.value.users.map(u => u.name);
                else newExp.value.splitTo = [];
            };

            const formatDate = (d) => d ? d.replace(/-/g, '/') : '';
            const formatMoney = (n) => n ? n.toLocaleString() : '0';
            const getCategoryIcon = (catName) => {
                const cat = categories.find(c => c.name === catName);
                return cat ? cat.icon : 'ğŸ’°';
            };

            const totalTripExpense = computed(() => {
                return tripExpenses.value.reduce((sum, item) => sum + item.amountTWD, 0);
            });

            const categoryTotals = computed(() => {
                const totals = {};
                tripExpenses.value.forEach(exp => {
                    totals[exp.category] = (totals[exp.category] || 0) + exp.amountTWD;
                });
                return totals;
            });

            // --- æ ¸å¿ƒé‚è¼¯ä¿®æ”¹ï¼šæ”¯æ´è‡ªè¨‚åˆ†å¸³ ---
            const userStats = computed(() => {
                if(!currentTrip.value) return [];
                const stats = {};
                currentTrip.value.users.forEach(u => {
                    stats[u.name] = { name: u.name, avatar: u.avatar, paid: 0, share: 0, balance: 0 };
                });
                
                tripExpenses.value.forEach(exp => {
                    // 1. èª°å…ˆå¢Šä»˜
                    if(stats[exp.payer.name]) stats[exp.payer.name].paid += exp.amountTWD;

                    // 2. èª°è©²åˆ†æ”¤ (å€åˆ†å…©ç¨®æ¨¡å¼)
                    if (exp.splitMethod === 'custom') {
                        // æ¨¡å¼ B: è‡ªè¨‚é‡‘é¡ (ä¾ç…§è©²ç­†è²»ç”¨çš„åŒ¯ç‡æ›ç®—å›å°å¹£)
                        if(exp.customAmounts) {
                            for(let name in exp.customAmounts) {
                                if(stats[name]) {
                                    // åŸå¹£åˆ¥é‡‘é¡ * åŒ¯ç‡ = å°å¹£æ‡‰ä»˜é¡
                                    const shareTWD = Math.round((exp.customAmounts[name] || 0) * exp.rate);
                                    stats[name].share += shareTWD;
                                }
                            }
                        }
                    } else {
                        // æ¨¡å¼ A: å¹³å‡åˆ†æ”¤ (é è¨­)
                        const splitCount = (exp.splitTo || []).length;
                        if(splitCount > 0) {
                            const shareAmount = exp.amountTWD / splitCount;
                            (exp.splitTo || []).forEach(name => {
                                if(stats[name]) stats[name].share += shareAmount;
                            });
                        }
                    }
                });

                Object.values(stats).forEach(s => s.balance = s.paid - s.share);
                return Object.values(stats);
            });

            const debts = computed(() => {
                let debtors = userStats.value.filter(s => s.balance < -1).map(s => ({...s}));
                let creditors = userStats.value.filter(s => s.balance > 1).map(s => ({...s}));
                debtors.sort((a,b) => a.balance - b.balance);
                creditors.sort((a,b) => b.balance - a.balance);
                const transactions = [];
                let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    let debtor = debtors[i];
                    let creditor = creditors[j];
                    let amount = Math.min(Math.abs(debtor.balance), creditor.balance);
                    transactions.push({ from: debtor.name, to: creditor.name, amount: Math.round(amount) });
                    debtor.balance += amount;
                    creditor.balance -= amount;
                    if(Math.abs(debtor.balance) < 1) i++;
                    if(creditor.balance < 1) j++;
                }
                return transactions;
            });

            onMounted(() => {
                fetchRates();
                if(currentUser.value) loadTrips();
            });

            return {
                currentUser, loginName, avatars, selectedAvatar, login,
                trips, currentTrip, showNewTripModal, newTrip, createTrip, selectTrip,
                formatDate, formatMoney, getCategoryIcon,
                tripExpenses, totalTripExpense, categoryTotals,
                showExpenseModal, openAddExpense, showSettlement,
                currencies, newExp, categories, updateRate, saveExpense,
                toggleSplitUser, toggleSplitAll, userStats, debts,
                openEditExpense, isEditing, updateExpense, deleteExpense,
                remainingAmount // New
            };
        }
    }).mount('#app');
</script>
</body>
</html>