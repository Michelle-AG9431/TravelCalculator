<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…è²»åˆ†å¸³ - æ–‡é’æ°´å½©ç‰ˆ (ä¿®å¾©ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Noto Serif TC', serif;
            background: #fdfbf7;
            background-image: 
                radial-gradient(at 10% 10%, rgba(255, 220, 220, 0.4) 0px, transparent 50%),
                radial-gradient(at 90% 0%, rgba(200, 230, 255, 0.4) 0px, transparent 50%),
                radial-gradient(at 50% 90%, rgba(220, 255, 220, 0.4) 0px, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #4a4a4a;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        .watercolor-btn {
            background-image: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            transition: all 0.3s ease;
        }
        .watercolor-btn:active { transform: scale(0.95); }
        .btn-edit { background-image: linear-gradient(120deg, #d4fc79 0%, #96e6a1 100%); }
        .btn-delete { background-image: linear-gradient(120deg, #fccb90 0%, #d57eeb 100%); }
        
        .tab-active { background-color: #bfdbfe; color: #1e3a8a; font-weight: bold; }
        .tab-inactive { background-color: #f3f4f6; color: #6b7280; }
        
        .readonly-banner {
            background: rgba(100, 100, 100, 0.1);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            color: #666;
            font-size: 0.8rem;
            text-align: center;
            padding: 4px;
        }

        .upload-box {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255,255,255,0.5);
        }
        .upload-box:hover { border-color: #93c5fd; background: rgba(255,255,255,0.8); }
        .image-preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid #ddd;
            cursor: zoom-in;
        }

        .modal-scroll::-webkit-scrollbar { width: 6px; }
        .modal-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 10px; }
        .modal-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="pb-24">

<div id="app" class="max-w-md mx-auto p-4 relative min-h-screen">

    <div v-if="!currentUser" class="flex flex-col items-center justify-center h-[80vh] space-y-6">
        <h1 class="text-3xl font-bold text-gray-700 tracking-widest">æ—…è²» Â· éš¨ç­†</h1>
        <p class="text-sm text-gray-500">ç´€éŒ„æ—…è¡Œä¸­çš„æ¯ä¸€ç­†ç¾å¥½</p>
        <div class="glass-card p-8 w-full">
            <label class="block mb-2 text-sm text-gray-600">ä½ çš„åå­—</label>
            <input v-model="loginName" type="text" class="w-full p-3 rounded-lg bg-white/50 border border-gray-200 focus:outline-none focus:border-blue-300 mb-4" placeholder="è¼¸å…¥æš±ç¨±...">
            <label class="block mb-2 text-sm text-gray-600">é¸æ“‡é ­åƒ</label>
            <div class="grid grid-cols-5 gap-2 mb-6">
                <button v-for="avi in avatars" :key="avi" @click="selectedAvatar = avi"
                    :class="{'ring-2 ring-blue-300 bg-blue-50': selectedAvatar === avi}"
                    class="text-2xl p-2 rounded-full hover:bg-gray-100 transition">
                    {{ avi }}
                </button>
            </div>
            <button @click="login" :disabled="!loginName" class="w-full watercolor-btn text-gray-700 font-bold py-3 rounded-xl shadow-md disabled:opacity-50">é–‹å§‹æ—…ç¨‹</button>
        </div>
    </div>

    <div v-else>
        <div v-if="currentTrip && isTripReadOnly" class="fixed top-0 left-0 right-0 z-40 readonly-banner backdrop-blur-sm">
            <i class="fas fa-lock"></i> æ­¤æ—…ç¨‹å·²éæœŸï¼ˆå”¯è®€å°å­˜æ¨¡å¼ï¼‰
        </div>

        <header class="flex justify-between items-center mb-6 pt-6">
            <div class="flex items-center gap-3">
                <div class="text-3xl bg-white rounded-full p-1 shadow-sm">{{ currentUser.avatar }}</div>
                <div>
                    <div class="font-bold text-lg">{{ currentUser.name }}</div>
                    <div v-if="currentTrip" class="text-xs text-gray-500 cursor-pointer" @click="exitTrip">
                        <i class="fas fa-chevron-left"></i> å›åˆ°è¡Œç¨‹åˆ—è¡¨
                    </div>
                </div>
            </div>
            <div v-if="currentTrip" class="flex gap-2">
                <button @click="openManagement" class="w-8 h-8 flex items-center justify-center bg-white/80 rounded-full shadow-sm text-gray-600">
                    <i class="fas fa-cog"></i>
                </button>
                <button @click="showSettlement = true" class="text-sm bg-white/80 px-3 py-1.5 rounded-full shadow-sm text-gray-600">
                    <i class="fas fa-calculator"></i> çµç®—
                </button>
            </div>
        </header>

        <div v-if="!currentTrip" class="space-y-4">
            <h2 class="text-xl font-bold text-gray-700 mb-4">æˆ‘çš„æ—…ç¨‹</h2>
            <div @click="openNewTripModal" class="glass-card p-6 flex flex-col items-center justify-center border-dashed border-2 border-gray-300 cursor-pointer hover:bg-white/90 transition text-gray-400">
                <i class="fas fa-plus text-2xl mb-2"></i>
                <span>é–‹å•Ÿä¸€æ®µæ–°æ—…ç¨‹</span>
            </div>

            <div v-for="trip in trips" :key="trip.id" class="glass-card p-5 relative overflow-hidden group">
                <div class="absolute -right-4 -top-4 text-6xl opacity-10 rotate-12 pointer-events-none">âœˆï¸</div>
                <div @click="selectTrip(trip)" class="cursor-pointer">
                    <h3 class="text-lg font-bold text-gray-800">{{ trip.name }}</h3>
                    <p class="text-xs text-gray-500 mt-1">{{ formatDate(trip.startDate) }} - {{ formatDate(trip.endDate) }}</p>
                    <div class="mt-3 flex -space-x-2">
                        <div v-for="u in trip.users" :key="u.name" class="w-6 h-6 rounded-full bg-gray-200 border-2 border-white flex items-center justify-center text-xs">
                            {{ u.avatar }}
                        </div>
                    </div>
                </div>
                <div class="absolute bottom-3 right-3 flex gap-2">
                    <button @click.stop="openEditTripModal(trip)" class="w-8 h-8 rounded-full bg-white/90 text-blue-500 shadow hover:bg-blue-50 flex items-center justify-center">
                        <i class="fas fa-pen"></i>
                    </button>
                    <button @click.stop="deleteTrip(trip)" class="w-8 h-8 rounded-full bg-white/90 text-red-400 shadow hover:bg-red-50 flex items-center justify-center">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>

        <div v-else>
            <div class="glass-card p-4 mb-4 bg-gradient-to-r from-blue-50 to-purple-50">
                <p class="text-xs text-gray-500">ç›®å‰ç¸½æ”¯å‡º (TWD)</p>
                <p class="text-3xl font-bold text-gray-800 font-sans tracking-tight">NT$ {{ formatMoney(totalTripExpense) }}</p>
                <div class="flex gap-2 mt-2 overflow-x-auto pb-1">
                     <span v-for="(amt, cat) in categoryTotals" :key="cat" class="category-tag whitespace-nowrap">
                        {{ cat }}: ${{ formatMoney(amt) }}
                     </span>
                </div>
            </div>

            <div class="space-y-3 pb-20">
                <div v-for="exp in tripExpenses" :key="exp.id" @click="openEditExpense(exp)" class="glass-card p-4 flex justify-between items-center group cursor-pointer hover:bg-white/90 transition">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-xl shadow-inner relative">
                            {{ getCategoryIcon(exp.category) }}
                            <div v-if="exp.imageUrl" 
                                 @click.stop="openImage(exp.imageUrl)"
                                 class="absolute -top-1 -right-1 text-blue-500 bg-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-md border hover:scale-110 transition z-10">
                                <i class="fas fa-paperclip"></i>
                            </div>
                        </div>
                        <div>
                            <p class="font-bold text-gray-700 leading-tight">{{ exp.note || exp.category }}</p>
                            <p class="text-xs text-gray-400 mt-0.5">
                                {{ exp.payer.name }} ä»˜æ¬¾ 
                                <span v-if="exp.splitMethod === 'custom'" class="text-blue-400 ml-1">(è‡ªè¨‚)</span>
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-gray-800">NT$ {{ formatMoney(exp.amountTWD) }}</p>
                        <p class="text-xs text-gray-400" v-if="exp.currency !== 'TWD'">
                            {{ exp.currency }} {{ exp.originalAmount }}
                        </p>
                    </div>
                </div>
                <div v-if="tripExpenses.length === 0" class="text-center text-gray-400 mt-10">
                    <i class="fas fa-pen-fancy text-4xl mb-3 opacity-30"></i>
                    <p>å°šæœªæœ‰ä»»ä½•èŠ±è²»ç´€éŒ„</p>
                </div>
            </div>

            <div v-if="!isTripReadOnly" class="fixed bottom-6 left-0 right-0 flex justify-center z-50">
                <button @click="openAddExpense" class="watercolor-btn text-gray-800 rounded-full px-8 py-4 shadow-lg flex items-center gap-2 transform hover:-translate-y-1 transition font-bold text-lg">
                    <i class="fas fa-plus"></i> æ–°å¢è²»ç”¨
                </button>
            </div>
        </div>
    </div>

    <div v-if="previewImageUrl" class="fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4 animate-fade-in" @click="previewImageUrl = null">
        <div class="relative max-w-full max-h-full">
            <img :src="previewImageUrl" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl">
            <button class="absolute -top-10 right-0 text-white text-3xl hover:text-gray-300">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div v-if="showTripModal" 
         @click.self="showTripModal = false"
         class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-card p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto modal-scroll">
            <h3 class="text-xl font-bold mb-4">{{ tripForm.id ? 'ç·¨è¼¯æ—…ç¨‹' : 'å»ºç«‹æ–°æ—…ç¨‹' }}</h3>
            <input v-model="tripForm.name" class="w-full p-2 mb-3 bg-white/50 border rounded" placeholder="æ—…ç¨‹åç¨± (å¦‚: å¤§é˜ªè¡Œ)">
            <div class="flex gap-2 mb-4">
                <div class="w-1/2">
                    <label class="text-xs text-gray-500">é–‹å§‹</label>
                    <input v-model="tripForm.startDate" type="date" class="w-full p-2 bg-white/50 border rounded">
                </div>
                <div class="w-1/2">
                    <label class="text-xs text-gray-500">çµæŸ</label>
                    <input v-model="tripForm.endDate" type="date" class="w-full p-2 bg-white/50 border rounded">
                </div>
            </div>
            <div class="flex justify-end gap-2">
                <button @click="showTripModal = false" class="px-4 py-2 text-gray-500">å–æ¶ˆ</button>
                <button v-if="!tripForm.id" @click="createTrip" class="px-6 py-2 bg-blue-200 rounded-lg font-bold">å»ºç«‹</button>
                <button v-else @click="updateTrip" class="px-6 py-2 btn-edit rounded-lg font-bold">æ›´æ–°</button>
            </div>
        </div>
    </div>

    <div v-if="showManagementModal" 
         @click.self="showManagementModal = false"
         class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-card p-6 w-full max-w-sm animate-slide-up max-h-[90vh] overflow-y-auto modal-scroll">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">æ—…ç¨‹ç®¡ç†</h3>
                <button @click="showManagementModal = false" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="mb-6">
                <h4 class="font-bold text-gray-600 mb-2 flex justify-between items-center">
                    <span>åŒ¯ç‡è¨­å®š</span>
                    <button v-if="!isTripReadOnly" @click="fetchLiveRatesForManagement" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full hover:bg-blue-200 transition">
                        <i class="fas fa-sync-alt"></i> ä¸€éµæ›´æ–°ç•¶å‰åŒ¯ç‡
                    </button>
                </h4>
                <div class="space-y-2 max-h-[50vh] overflow-y-auto pr-2">
                    <div v-for="curr in currencies" :key="curr" v-show="curr !== 'TWD'" class="flex items-center justify-between border-b border-gray-100 pb-2">
                        <span class="font-bold text-gray-700 w-12">{{ curr }}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-400">1 {{curr}} â‰ˆ</span>
                            <input :disabled="isTripReadOnly" type="number" step="0.01" v-model.number="editingRates[curr]" class="w-20 p-1 bg-white border border-gray-200 rounded text-right font-bold text-gray-800 focus:border-blue-300 outline-none disabled:text-gray-400">
                            <span class="text-xs text-gray-500">TWD</span>
                        </div>
                    </div>
                </div>
            </div>
            <button v-if="!isTripReadOnly" @click="saveManagementSettings" class="w-full watercolor-btn py-3 rounded-xl font-bold text-gray-800 shadow-md">å„²å­˜è¨­å®š</button>
        </div>
    </div>

    <div v-if="showExpenseModal" 
         @click.self="showExpenseModal = false"
         class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center">
         
        <div class="glass-card w-full max-w-md rounded-b-none sm:rounded-2xl p-6 max-h-[90vh] overflow-y-auto modal-scroll animate-slide-up">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">{{ isEditing ? 'ç·¨è¼¯è²»ç”¨' : 'è¨˜ä¸€ç­†' }}</h3>
                <button @click="showExpenseModal = false" class="text-gray-400"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div v-if="isTripReadOnly" class="mb-4 p-2 bg-gray-100 text-center rounded text-sm text-gray-500">å”¯è®€æ¨¡å¼ï¼šåƒ…ä¾›æª¢è¦–</div>

            <div class="mb-4">
                <label class="text-xs text-gray-500 block mb-2">å–®æ“šç…§ç‰‡</label>
                
                <div v-if="newExp.imageUrl" class="relative">
                    <img :src="newExp.imageUrl" @click="openImage(newExp.imageUrl)" class="image-preview" alt="Receipt">
                    <button v-if="!isTripReadOnly" @click="removeImage" class="absolute top-2 right-2 bg-white/80 p-1 rounded-full text-red-500 shadow-sm">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>

                <div v-else-if="!isTripReadOnly">
                    <label v-if="!isUploading" class="upload-box flex flex-col items-center justify-center text-gray-400">
                        <i class="fas fa-camera text-2xl mb-1"></i>
                        <span class="text-xs">é»æ“Šä¸Šå‚³ç…§ç‰‡</span>
                        <input type="file" accept="image/*" class="hidden" @change="handleFileUpload">
                    </label>
                    <div v-else class="upload-box flex flex-col items-center justify-center text-blue-400">
                        <i class="fas fa-spinner fa-spin text-2xl mb-1"></i>
                        <span class="text-xs">åœ–ç‰‡å£“ç¸®ä¸Šå‚³ä¸­...</span>
                    </div>
                </div>
                <div v-else class="text-center text-gray-400 text-xs py-4 border border-dashed rounded-lg">
                    ç„¡ç…§ç‰‡
                </div>
            </div>

            <div class="flex gap-2 mb-4">
                <div class="w-1/3">
                    <label class="text-xs text-gray-500 block mb-1">å¹£åˆ¥</label>
                    <select :disabled="isTripReadOnly" v-model="newExp.currency" @change="updateRateFromSettings" class="w-full p-3 bg-white border border-gray-200 rounded-lg appearance-none">
                        <option v-for="c in currencies" :value="c">{{ c }}</option>
                    </select>
                </div>
                <div class="w-2/3">
                    <label class="text-xs text-gray-500 block mb-1">é‡‘é¡</label>
                    <input :disabled="isTripReadOnly" v-model.number="newExp.amount" type="number" class="w-full p-3 bg-white border border-gray-200 rounded-lg text-lg font-bold text-right" placeholder="0">
                </div>
            </div>

            <div class="mb-4 bg-gray-50 p-3 rounded-lg flex justify-between items-center">
                <span class="text-xs text-gray-500">åŒ¯ç‡ (1 {{newExp.currency}} = ? TWD)</span>
                <input :disabled="isTripReadOnly" v-model.number="newExp.rate" type="number" step="0.01" class="w-20 bg-transparent text-right border-b border-gray-300 focus:outline-none text-sm">
            </div>
            <p class="text-right text-sm font-bold text-gray-700 mb-4">
                â‰ˆ NT$ {{ formatMoney(Math.round(newExp.amount * newExp.rate)) }}
            </p>

            <div class="grid grid-cols-5 gap-2 mb-4">
                <div v-for="cat in categories" :key="cat.name" 
                     @click="!isTripReadOnly && (newExp.category = cat.name)"
                     :class="{'bg-blue-100 border-blue-300': newExp.category === cat.name}"
                     class="flex flex-col items-center p-2 rounded-lg border border-transparent cursor-pointer transition">
                    <div class="text-xl mb-1">{{ cat.icon }}</div>
                    <span class="text-[10px]">{{ cat.name }}</span>
                </div>
            </div>

            <input :disabled="isTripReadOnly" v-model="newExp.note" class="w-full p-3 bg-white border border-gray-200 rounded-lg mb-4" placeholder="å‚™è¨» (å¦‚: æ™šé¤ã€è»Šç¥¨...)">

            <div class="mb-4">
                <label class="text-xs text-gray-500 block mb-2">èª°å…ˆä»˜çš„ï¼Ÿ</label>
                <div class="flex gap-2 overflow-x-auto pb-1">
                    <button v-for="u in currentTrip.users" :key="u.name"
                        @click="!isTripReadOnly && (newExp.payer = u)"
                        :class="{'ring-2 ring-blue-400 bg-blue-50': newExp.payer.name === u.name}"
                        class="flex items-center gap-2 px-3 py-2 rounded-full border bg-white min-w-max">
                        <span>{{ u.avatar }}</span>
                        <span class="text-sm">{{ u.name }}</span>
                    </button>
                </div>
            </div>

            <div class="mb-6">
                <label class="text-xs text-gray-500 block mb-2">åˆ†çµ¦èª°ï¼Ÿ</label>
                <div class="flex mb-3 rounded-lg overflow-hidden border border-gray-200">
                    <button @click="!isTripReadOnly && (newExp.splitMethod = 'equal')" class="flex-1 py-2 text-sm transition" :class="newExp.splitMethod === 'equal' ? 'tab-active' : 'tab-inactive'">å¹³å‡åˆ†æ”¤</button>
                    <button @click="!isTripReadOnly && (newExp.splitMethod = 'custom')" class="flex-1 py-2 text-sm transition" :class="newExp.splitMethod === 'custom' ? 'tab-active' : 'tab-inactive'">è‡ªè¨‚é‡‘é¡</button>
                </div>

                <div v-if="newExp.splitMethod === 'equal'">
                    <div v-if="!isTripReadOnly" class="flex gap-2 mb-2">
                        <button @click="toggleSplitAll(true)" class="text-xs px-2 py-1 bg-gray-200 rounded">å…¨é¸</button>
                        <button @click="toggleSplitAll(false)" class="text-xs px-2 py-1 bg-gray-200 rounded">å…¨ä¸é¸</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div v-for="u in currentTrip.users" :key="u.name + 'split'" 
                             @click="!isTripReadOnly && toggleSplitUser(u)"
                             :class="{'bg-green-50 border-green-300': newExp.splitTo.includes(u.name)}"
                             class="flex items-center gap-2 p-2 rounded border border-gray-200 cursor-pointer">
                            <div v-if="newExp.splitTo.includes(u.name)" class="text-green-500"><i class="fas fa-check-circle"></i></div>
                            <div v-else class="text-gray-300"><i class="far fa-circle"></i></div>
                            <span class="text-sm">{{ u.name }}</span>
                        </div>
                    </div>
                </div>

                <div v-else>
                    <div class="space-y-2 max-h-40 overflow-y-auto">
                        <div v-for="u in currentTrip.users" :key="u.name + 'custom'" class="flex items-center justify-between p-2 border-b border-gray-100">
                            <div class="flex items-center gap-2">
                                <span>{{ u.avatar }}</span>
                                <span class="text-sm">{{ u.name }}</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="text-xs text-gray-400">{{ newExp.currency }}</span>
                                <input :disabled="isTripReadOnly" type="number" v-model.number="newExp.customAmounts[u.name]" class="w-24 p-1 bg-gray-50 border rounded text-right text-sm" placeholder="0">
                            </div>
                        </div>
                    </div>
                    <div class="mt-2 text-right text-sm font-bold">
                        <span :class="remainingAmount === 0 ? 'text-green-500' : 'text-red-500'">
                            {{ remainingAmount === 0 ? 'å·²åˆ†é…å®Œç•¢' : (remainingAmount > 0 ? `é‚„æœ‰ ${formatMoney(remainingAmount)} æœªåˆ†` : `è¶…åˆ†äº† ${formatMoney(Math.abs(remainingAmount))}`) }}
                        </span>
                    </div>
                </div>
            </div>

            <div v-if="!isTripReadOnly">
                <div v-if="!isEditing">
                    <button @click="saveExpense" :disabled="isUploading || (newExp.splitMethod === 'custom' && remainingAmount !== 0)" class="w-full watercolor-btn py-3 rounded-xl font-bold text-gray-800 shadow-md disabled:opacity-50 disabled:grayscale">
                        {{ isUploading ? 'åœ–ç‰‡ä¸Šå‚³ä¸­...' : 'å„²å­˜è²»ç”¨' }}
                    </button>
                </div>
                <div v-else class="flex gap-3">
                    <button @click="deleteExpense" class="flex-1 bg-red-100 text-red-600 py-3 rounded-xl font-bold shadow-md"><i class="fas fa-trash-alt"></i> åˆªé™¤</button>
                    <button @click="updateExpense" :disabled="isUploading || (newExp.splitMethod === 'custom' && remainingAmount !== 0)" class="flex-[2] watercolor-btn py-3 rounded-xl font-bold text-gray-800 shadow-md disabled:opacity-50 disabled:grayscale">
                        {{ isUploading ? 'åœ–ç‰‡ä¸Šå‚³ä¸­...' : 'ç¢ºèªä¿®æ”¹' }}
                    </button>
                </div>
            </div>
            <div v-else class="text-center text-gray-400">
                (å”¯è®€æ¨¡å¼ï¼šç„¡æ³•ä¿®æ”¹)
            </div>
        </div>
    </div>

    <div v-if="showSettlement" 
         @click.self="showSettlement = false"
         class="fixed inset-0 bg-white z-50 overflow-y-auto p-6 animate-fade-in">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold">çµç®—å ±è¡¨</h2>
                <button @click="showSettlement = false" class="p-2 bg-gray-100 rounded-full"><i class="fas fa-times"></i></button>
            </div>

            <div class="space-y-6">
                <div v-if="debts.length > 0">
                    <h3 class="font-bold text-gray-600 mb-3 border-l-4 border-blue-300 pl-2">å»ºè­°è½‰å¸³</h3>
                    <div v-for="(debt, idx) in debts" :key="idx" class="glass-card p-4 flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-red-500">{{ debt.from }}</span>
                            <i class="fas fa-arrow-right text-gray-300"></i>
                            <span class="font-bold text-green-600">{{ debt.to }}</span>
                        </div>
                        <div class="font-bold text-lg">NT$ {{ formatMoney(debt.amount) }}</div>
                    </div>
                </div>
                <div v-else class="text-center text-gray-400 py-4">ç›®å‰æ”¶æ”¯å¹³è¡¡ï¼Œç„¡éœ€è½‰å¸³ï¼</div>
                <hr class="border-gray-200">
                <div>
                    <h3 class="font-bold text-gray-600 mb-3 border-l-4 border-purple-300 pl-2">å€‹äººæ”¶æ”¯è©³æƒ…</h3>
                    <div v-for="stat in userStats" :key="stat.name" class="glass-card p-4 mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">{{ stat.avatar }}</span>
                                <span class="font-bold">{{ stat.name }}</span>
                            </div>
                            <span :class="stat.balance >= 0 ? 'text-green-600' : 'text-red-500'" class="font-bold">{{ stat.balance >= 0 ? 'æ”¶' : 'ä»˜' }} NT$ {{ formatMoney(Math.abs(stat.balance)) }}</span>
                        </div>
                        <div class="text-xs text-gray-500 flex justify-between">
                            <span>å…ˆå¢Šä»˜: {{ formatMoney(stat.paid) }}</span>
                            <span>æ‡‰åˆ†æ”¤: {{ formatMoney(stat.share) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // --- ã€é‡è¦ã€‘è«‹å‹™å¿…å†æ¬¡å¡«å…¥ä½ çš„ FIREBASE è¨­å®š ---
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com", // <-- è«‹ç¢ºèªæ­¤è¡Œæ˜¯å¦å­˜åœ¨
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    let db;
    let storage;

    if (firebaseConfig.apiKey === "YOUR_API_KEY") {
        alert("è«‹è¨˜å¾—åœ¨ index.html ç¨‹å¼ç¢¼ä¸­å†æ¬¡å¡«å…¥æ‚¨çš„ Firebase Configï¼");
    } else {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        storage = firebase.storage();
    }

    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const currentUser = ref(JSON.parse(localStorage.getItem('travel_user')) || null);
            const loginName = ref('');
            const selectedAvatar = ref('ğŸ¦Š');
            const avatars = ['ğŸ¦Š', 'ğŸ±', 'ğŸ¶', 'ğŸ°', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ·', 'ğŸ¸'];
            
            const trips = ref([]);
            const currentTrip = ref(null);
            const tripExpenses = ref([]);
            
            const showTripModal = ref(false);
            const showExpenseModal = ref(false);
            const showSettlement = ref(false);
            const showManagementModal = ref(false);
            
            // é è¦½åœ–ç‰‡è®Šæ•¸
            const previewImageUrl = ref(null);

            const isEditing = ref(false);
            const currentExpenseId = ref(null);
            const isUploading = ref(false);

            const currencies = ['TWD', 'USD', 'EUR', 'JPY', 'KRW', 'THB', 'HKD'];
            const exchangeRates = ref({ TWD: 1 });
            const editingRates = ref({});

            const tripForm = ref({ id: null, name: '', startDate: '', endDate: '' });

            const categories = [
                {name: 'äº¤é€š', icon: 'ğŸš„'}, {name: 'é£²é£Ÿ', icon: 'ğŸœ'}, {name: 'ä½å®¿', icon: 'ğŸ¨'}, 
                {name: 'é–€ç¥¨', icon: 'ğŸŸï¸'}, {name: 'è³¼ç‰©', icon: 'ğŸ›ï¸'}, {name: 'å…¶ä»–', icon: 'âœ¨'}
            ];
            
            const newExp = ref({
                amount: null, currency: 'TWD', rate: 1, category: 'é£²é£Ÿ', note: '', payer: null,
                splitMethod: 'equal', splitTo: [], customAmounts: {},
                imageUrl: ''
            });

            const isTripReadOnly = computed(() => {
                if (!currentTrip.value || !currentTrip.value.endDate) return false;
                const end = new Date(currentTrip.value.endDate);
                const now = new Date();
                end.setHours(23, 59, 59);
                const deadline = new Date(end);
                deadline.setDate(end.getDate() + 30);
                return now > deadline;
            });

            const login = () => {
                const user = { name: loginName.value, avatar: selectedAvatar.value };
                currentUser.value = user;
                localStorage.setItem('travel_user', JSON.stringify(user));
                loadTrips();
            };

            const getApiRates = async () => {
                try {
                    const res = await fetch('https://open.er-api.com/v6/latest/TWD');
                    const data = await res.json();
                    let rates = {};
                    currencies.forEach(c => {
                        if (data.rates[c]) rates[c] = parseFloat((1 / data.rates[c]).toFixed(2));
                    });
                    rates['TWD'] = 1;
                    return rates;
                } catch (e) { console.error(e); return null; }
            };

            const initRates = async () => {
                const rates = await getApiRates();
                if(rates) exchangeRates.value = rates;
            };

            const loadTrips = () => {
                if(!db) return;
                db.collection('trips').orderBy('createdAt', 'desc').onSnapshot(snap => {
                    trips.value = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                });
            };

            const openNewTripModal = () => {
                tripForm.value = { id: null, name: '', startDate: '', endDate: '' };
                showTripModal.value = true;
            };

            const openEditTripModal = (trip) => {
                tripForm.value = { 
                    id: trip.id, name: trip.name, startDate: trip.startDate, endDate: trip.endDate 
                };
                showTripModal.value = true;
            };

            const createTrip = async () => {
                if(!tripForm.value.name) return;
                const tripData = {
                    name: tripForm.value.name,
                    startDate: tripForm.value.startDate,
                    endDate: tripForm.value.endDate,
                    users: [currentUser.value],
                    savedRates: exchangeRates.value,
                    createdAt: new Date().toISOString()
                };
                await db.collection('trips').add(tripData);
                showTripModal.value = false;
            };

            const updateTrip = async () => {
                if(!tripForm.value.id) return;
                await db.collection('trips').doc(tripForm.value.id).update({
                    name: tripForm.value.name,
                    startDate: tripForm.value.startDate,
                    endDate: tripForm.value.endDate
                });
                showTripModal.value = false;
            };

            const deleteTrip = async (trip) => {
                if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${trip.name}ã€å—ï¼Ÿ\n\nè­¦å‘Šï¼šé€™å°‡æœƒä¸€ä½µåˆªé™¤è©²æ—…ç¨‹å…§çš„æ‰€æœ‰è²»ç”¨ç´€éŒ„ï¼Œä¸”ç„¡æ³•å¾©åŸï¼`)) return;
                try {
                    const snap = await db.collection('expenses').where('tripId', '==', trip.id).get();
                    const batch = db.batch();
                    snap.docs.forEach(doc => { batch.delete(doc.ref); });
                    const tripRef = db.collection('trips').doc(trip.id);
                    batch.delete(tripRef);
                    await batch.commit();
                    alert("åˆªé™¤æˆåŠŸï¼");
                } catch (e) {
                    console.error("åˆªé™¤å¤±æ•—", e);
                    alert("åˆªé™¤å¤±æ•—");
                }
            };

            const selectTrip = (trip) => {
                currentTrip.value = trip;
                const isMember = trip.users.find(u => u.name === currentUser.value.name);
                if (!isMember) {
                    const updatedUsers = [...trip.users, currentUser.value];
                    db.collection('trips').doc(trip.id).update({ users: updatedUsers });
                    currentTrip.value.users = updatedUsers;
                }
                if (trip.savedRates) exchangeRates.value = trip.savedRates;
                loadExpenses(trip.id);
            };

            const exitTrip = () => {
                currentTrip.value = null;
                tripExpenses.value = [];
            }

            const openManagement = () => {
                editingRates.value = JSON.parse(JSON.stringify(exchangeRates.value));
                showManagementModal.value = true;
            };

            const fetchLiveRatesForManagement = async () => {
                const rates = await getApiRates();
                if(rates) {
                    editingRates.value = rates;
                    alert("åŒ¯ç‡å·²æ›´æ–°è‡³æœ€æ–°å¸‚åƒ¹ï¼Œè«‹è¨˜å¾—æŒ‰ä¸‹ã€Œå„²å­˜è¨­å®šã€ï¼");
                }
            };

            const saveManagementSettings = async () => {
                if(!currentTrip.value) return;
                exchangeRates.value = JSON.parse(JSON.stringify(editingRates.value));
                await db.collection('trips').doc(currentTrip.value.id).update({
                    savedRates: editingRates.value
                });
                showManagementModal.value = false;
            };

            const loadExpenses = (tripId) => {
                db.collection('expenses').where('tripId', '==', tripId).onSnapshot(snap => {
                      let list = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      list.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                      tripExpenses.value = list;
                  });
            };

            // é–‹å•Ÿå…¨è¢å¹•åœ–ç‰‡
            const openImage = (url) => {
                if(url) previewImageUrl.value = url;
            };

            const openAddExpense = () => {
                if(isTripReadOnly.value) return;
                isEditing.value = false;
                currentExpenseId.value = null;
                isUploading.value = false;
                let initialCustom = {};
                currentTrip.value.users.forEach(u => initialCustom[u.name] = 0);
                newExp.value = {
                    amount: null, currency: 'TWD', rate: 1, category: 'é£²é£Ÿ', note: '', payer: currentUser.value,
                    splitMethod: 'equal', splitTo: currentTrip.value.users.map(u => u.name), customAmounts: initialCustom,
                    imageUrl: ''
                };
                showExpenseModal.value = true;
            };

            const openEditExpense = (exp) => {
                isEditing.value = true;
                currentExpenseId.value = exp.id;
                isUploading.value = false;
                let loadedCustom = exp.customAmounts || {};
                currentTrip.value.users.forEach(u => { if(loadedCustom[u.name] === undefined) loadedCustom[u.name] = 0; });
                newExp.value = {
                    amount: exp.originalAmount, currency: exp.currency, rate: exp.rate, category: exp.category, note: exp.note, payer: exp.payer,
                    splitMethod: exp.splitMethod || 'equal', splitTo: [...(exp.splitTo || [])], customAmounts: loadedCustom,
                    imageUrl: exp.imageUrl || ''
                };
                showExpenseModal.value = true;
            };

            const resizeImage = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800;
                            let width = img.width;
                            let height = img.height;
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            canvas.toBlob((blob) => {
                                resolve(blob);
                            }, 'image/jpeg', 0.8);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                isUploading.value = true;
                try {
                    const resizedBlob = await resizeImage(file);
                    const filename = `${Date.now()}_${file.name}`;
                    const storageRef = storage.ref().child(`receipts/${currentTrip.value.id}/${filename}`);
                    const snapshot = await storageRef.put(resizedBlob);
                    const url = await snapshot.ref.getDownloadURL();
                    newExp.value.imageUrl = url;
                } catch (error) {
                    console.error("Upload failed", error);
                    alert("åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase Storage è¨­å®š");
                } finally {
                    isUploading.value = false;
                }
            };

            const removeImage = () => {
                if(confirm("ç¢ºå®šè¦ç§»é™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ")) {
                    newExp.value.imageUrl = '';
                }
            };

            const updateRateFromSettings = () => {
                const cur = newExp.value.currency;
                if(exchangeRates.value[cur]) {
                    newExp.value.rate = parseFloat(exchangeRates.value[cur]);
                }
            };

            const remainingAmount = computed(() => {
                if(!newExp.value.amount) return 0;
                let assigned = 0;
                for (let name in newExp.value.customAmounts) assigned += (newExp.value.customAmounts[name] || 0);
                return parseFloat((newExp.value.amount - assigned).toFixed(2));
            });

            const getExpenseDataObj = () => {
                 return {
                    amountTWD: Math.round(newExp.value.amount * newExp.value.rate),
                    originalAmount: newExp.value.amount,
                    currency: newExp.value.currency,
                    rate: newExp.value.rate,
                    category: newExp.value.category,
                    note: newExp.value.note,
                    payer: newExp.value.payer,
                    splitMethod: newExp.value.splitMethod,
                    splitTo: newExp.value.splitTo,
                    customAmounts: newExp.value.customAmounts,
                    imageUrl: newExp.value.imageUrl
                };
            };

            const saveExpense = async () => {
                if(!newExp.value.amount) return;
                const baseData = getExpenseDataObj();
                const expenseData = { ...baseData, tripId: currentTrip.value.id, date: new Date().toLocaleDateString('zh-TW'), timestamp:
