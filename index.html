<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅遊分帳計算機 (TravelCalculator)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; }
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
    </style>
</head>
<body>

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-lg relative">
        
        <header class="bg-blue-600 text-white p-4 sticky top-0 z-10 shadow-md">
            <h1 class="text-xl font-bold flex justify-between items-center">
                日本旅遊分帳
                <span class="text-sm font-normal bg-blue-700 px-2 py-1 rounded">總支出: ¥{{ totalAmount }}</span>
            </h1>
        </header>

        <main class="p-4 pb-24">
            <div v-if="expenses.length === 0" class="text-center text-gray-400 mt-10">
                <p>目前還沒有任何支出紀錄</p>
                <p class="text-sm">點擊右下角按鈕新增第一筆</p>
            </div>

            <div v-else class="space-y-3">
                <div v-for="expense in expenses" :key="expense.id" class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex justify-between items-center">
                    <div>
                        <div class="font-bold text-gray-800">{{ expense.item }}</div>
                        <div class="text-xs text-gray-500">
                            {{ expense.payer }} 付款 · {{ formatDate(expense.date) }}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-blue-600">¥{{ expense.amount }}</div>
                        <div class="text-xs text-gray-400">分攤: {{ expense.splitBy }}</div>
                    </div>
                </div>
            </div>
        </main>

        <button 
            @click="openAddExpense" 
            class="fixed bottom-6 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center text-3xl hover:bg-blue-700 transition active:scale-95 z-20">
            +
        </button>

        <transition name="modal">
            <div v-if="showAddExpenseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
                    <div class="bg-gray-100 px-4 py-3 border-b flex justify-between items-center">
                        <h3 class="font-bold text-gray-700">記一筆</h3>
                        <button @click="closeAddExpense" class="text-gray-500 hover:text-gray-700">✕</button>
                    </div>
                    
                    <div class="p-4 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">項目名稱</label>
                            <input v-model="newExpense.item" type="text" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例如：章魚燒">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">金額 (日幣)</label>
                                <input v-model.number="newExpense.amount" type="number" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">付款人</label>
                                <select v-model="newExpense.payer" class="w-full border rounded-lg p-2 bg-white">
                                    <option v-for="user in users" :key="user" :value="user">{{ user }}</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">誰要分攤？</label>
                            <div class="flex gap-2 flex-wrap">
                                <label v-for="user in users" :key="user" class="flex items-center space-x-2 bg-gray-50 px-3 py-1 rounded border cursor-pointer">
                                    <input type="checkbox" :value="user" v-model="newExpense.involved" class="text-blue-600 rounded">
                                    <span class="text-sm">{{ user }}</span>
                                </label>
                            </div>
                        </div>

                        <button 
                            @click="submitExpense" 
                            :disabled="isSubmitting"
                            class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition disabled:bg-gray-400">
                            {{ isSubmitting ? '儲存中...' : '確認新增' }}
                        </button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { createApp, ref, computed, onMounted } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

        // ==========================================
        // TODO: 請將你的 Firebase 設定貼在這裡
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBSMNzpBI4SiECFCEt_HUaYoaGb1_gaLSI",
          authDomain: "travelcalculator-10c81.firebaseapp.com",
          projectId: "travelcalculator-10c81",
          storageBucket: "travelcalculator-10c81.firebasestorage.app",
          messagingSenderId: "776646417150",
          appId: "1:776646417150:web:e8be691a3eb7ad8d1723af",
          measurementId: "G-N1G80VWVT7"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Vue 應用程式邏輯
        createApp({
            setup() {
                // 資料變數
                const users = ref(["我", "朋友A", "朋友B"]); // 這裡可以改成你實際的朋友名字
                const expenses = ref([]);
                const showAddExpenseModal = ref(false); // 控制彈窗顯示
                const isSubmitting = ref(false);
                
                // 新增支出的表單資料
                const newExpense = ref({
                    item: "",
                    amount: "",
                    payer: "我",
                    involved: ["我", "朋友A", "朋友B"] // 預設全選
                });

                // ★★★ 這是之前漏掉的函式，現在補上了 ★★★
                // 打開新增視窗
                const openAddExpense = () => {
                    console.log("打開視窗函式被呼叫了");
                    showAddExpenseModal.value = true;
                };

                // 關閉新增視窗
                const closeAddExpense = () => {
                    showAddExpenseModal.value = false;
                };

                // 提交表單到 Firebase
                const submitExpense = async () => {
                    if (!newExpense.value.item || !newExpense.value.amount) {
                        alert("請輸入項目和金額！");
                        return;
                    }

                    isSubmitting.value = true;
                    try {
                        await addDoc(collection(db, "expenses"), {
                            item: newExpense.value.item,
                            amount: Number(newExpense.value.amount),
                            payer: newExpense.value.payer,
                            splitBy: newExpense.value.involved.join(", "),
                            date: serverTimestamp() // 使用伺服器時間
                        });
                        
                        // 清空表單並關閉
                        newExpense.value.item = "";
                        newExpense.value.amount = "";
                        closeAddExpense();
                    } catch (e) {
                        console.error("寫入錯誤: ", e);
                        alert("儲存失敗，請檢查 Firebase 規則或網路。");
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                // 監聽 Firebase 資料庫變化 (即時更新列表)
                onMounted(() => {
                    const q = query(collection(db, "expenses"), orderBy("date", "desc"));
                    onSnapshot(q, (snapshot) => {
                        expenses.value = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                    });
                });

                // 計算總金額
                const totalAmount = computed(() => {
                    return expenses.value.reduce((sum, item) => sum + item.amount, 0);
                });

                // 格式化日期的小工具
                const formatDate = (timestamp) => {
                    if (!timestamp) return "";
                    // 處理 Firebase Timestamp
                    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                };

                // ★★★ 這裡一定要把 HTML 會用到的變數都 return 出去 ★★★
                return {
                    users,
                    expenses,
                    showAddExpenseModal,
                    newExpense,
                    isSubmitting,
                    totalAmount,
                    // 函式
                    openAddExpense, // 這就是原本缺少的！
                    closeAddExpense,
                    submitExpense,
                    formatDate
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
